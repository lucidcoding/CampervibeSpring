package uk.co.luciditysoftware.campervibe.site.controllers;

import java.io.IOException;
import java.util.List;

import javax.inject.Inject;
import javax.validation.Valid;

import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.hibernate.Transaction;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.view.RedirectView;

import uk.co.luciditysoftware.campervibe.domain.common.ValidationMessage;
import uk.co.luciditysoftware.campervibe.domain.entities.Booking;
import uk.co.luciditysoftware.campervibe.domain.repositorycontracts.UserRepository;
import uk.co.luciditysoftware.campervibe.domain.requests.booking.MakeRequest;
import uk.co.luciditysoftware.campervibe.site.viewmodels.account.RegisterViewModel;
import uk.co.luciditysoftware.campervibe.site.viewmodels.booking.MakeViewModel;

@Controller
public class AccountController {
	private SessionFactory sessionFactory;
	private UserRepository userRepository;
	
	@Inject 
	public void setSessionFactory(SessionFactory sessionFactory) {
		this.sessionFactory = sessionFactory;
	}
	
	@Inject 
	public void setUserRepository(UserRepository userRepository) {
		this.userRepository = userRepository;
	}
	
	@RequestMapping(value = { "/account/login" }, method = RequestMethod.GET)
    public String login()
    {
        return "account/login";
    }
	
	@RequestMapping(value = "/booking/make", method = RequestMethod.GET)
	public ModelAndView make() {
		//Session session = sessionFactory.getCurrentSession();
		//Transaction transaction = session.beginTransaction();
		RegisterViewModel viewModel = new RegisterViewModel();
		//transaction.commit();
		return new ModelAndView("booking/make", "viewModel", viewModel);
	}
	
	@RequestMapping(value = "/booking/make", method = RequestMethod.POST)
	public ModelAndView make(@Valid @ModelAttribute("viewModel") RegisterViewModel viewModel, BindingResult bindingResult) throws IOException {
		Session session = sessionFactory.getCurrentSession();
		Transaction transaction = session.beginTransaction();
		
		if(bindingResult.hasErrors()) {
			ModelAndView modelAndView = new ModelAndView("booking/make", "viewModel", viewModel);
			modelAndView.addObject("errors", bindingResult);
			return modelAndView;
		}
		
		MakeRequest makeRequest = new MakeRequest();
		makeRequest.setVehicle(vehicleRepository.getById(viewModel.getVehicleId()));
		makeRequest.setStartDate(viewModel.getStartDate());
		makeRequest.setEndDate(viewModel.getEndDate());
		List<ValidationMessage> validationMessages = Booking.validateMake(makeRequest);
		Booking booking = Booking.make(makeRequest);
		bookingRepository.save(booking);
		transaction.commit();
		return new ModelAndView(new RedirectView("index"));
	}
}
